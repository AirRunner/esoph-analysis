---
title: "Project"
author: "KIESGEN de RICHTER Stanislas – VAIO Luca"
date: "10/2/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Discovering the dataset

Our dataset comes from a case-control study of oesophageal cancer conducted in Ile-et-Vilaine, France. The dataset is composed of a factor of age group, alcohol consumption and tobacco consumption. The number of cases and controls are given for each group. The aim of the study is to confirm the correlation between cancers and age, as well as consummation of tobacco and consummation of alcohol. 

Let's first explore the dataset. Here is the beginning, and its summary:

```{r}
head(esoph, 8)
cat("Number of combinations: ", dim(esoph)[1], "\nNumber of persons checked: ",
    sum(esoph$ncontrols))
```
The study takes into account the age group of each individual, along with their alcohol and tobacco consumption per day. The age groups start at 25 and are divided by ranges of 10 years, the alcohol by ranges of 40g/day and the tobacco by ranges of 10g/day.
In the dataset, each combination of the three groups is presented with the corresponding number of controls and cases.

```{r}
summary(esoph)
```

In the summary, the first three columns only represent the number of lines of 'agegp', 'alcgp' and 'tobgp'. We cannot get any valuable information from this, in fact these variables are qualitative:

```{r}
str(esoph)
```

The cases go from 0 to 17 by combination. The maximum seems to be quite far from the median, and even the third quartile which is 4, meaning that there is a peak in one of the combinations.
As we see in the last column, the controls are not equally distributed: the controls vary from 1 to 60 depending on the group combination. This means that the combinations of the three groups (age, alc, tob) are not equally distributed.
Therefore, we will have to compute correlation indexes between the different variables.


## Visualising the data

As said before, one issue is that the controls are not equally distributed, the next bar plot allows to visualize it.

```{r}
cases = tapply(esoph$ncases, esoph$agegp, sum)
controls = tapply(esoph$ncontrols, esoph$agegp, sum)

non_cases = controls - cases
percentages = cases / controls * 100

ylim <- c(0, 1.1*max(controls))
plot <- barplot(rbind(cases, non_cases), ylim=ylim, legend=c("Cases", "Non cases"),
                col=c("#990000", "#CCFF99"), xlab="Age group", ylab="Frequency")
text(x=plot, y=controls, label=paste(round(percentages, 2), "%"), pos=3)
```
```{r}
cases = tapply(esoph$ncases, esoph$alcgp, sum)
controls = tapply(esoph$ncontrols, esoph$alcgp, sum)

non_cases = controls - cases
percentages = cases / controls * 100

ylim <- c(0, 1.1*max(controls))
plot <- barplot(rbind(cases, non_cases), ylim=ylim, legend=c("Cases", "Non cases"),
                col=c("#990000", "#CCFF99"), xlab="Alcohol group", ylab="Frequency")
text(x=plot, y=controls, label=paste(round(percentages, 2), "%"), pos=3)
```
```{r}
cases = tapply(esoph$ncases, esoph$tobgp, sum)
controls = tapply(esoph$ncontrols, esoph$tobgp, sum)

non_cases = controls - cases
percentages = cases / controls * 100

ylim <- c(0, 1.1*max(controls))
plot <- barplot(rbind(cases, non_cases), ylim=ylim, legend=c("Cases", "Non cases"),
                col=c("#990000", "#CCFF99"), xlab="Tobacco group", ylab="Frequency")
text(x=plot, y=controls, label=paste(round(percentages, 2), "%"), pos=3)
```

Total proportion of cases by age group. We clearly see that cases are more present from 45 to 75+ years old.
```{r}
total_prop = tapply(esoph$ncases, esoph$agegp, sum) / tapply(esoph$ncontrols, esoph$agegp, sum) * 100

plot(unique(esoph$agegp), total_prop, xlab="Age group", ylab="Proportion")
```


```{r}
total_prop_alc = tapply(esoph$ncases, esoph$alcgp, sum) / tapply(esoph$ncontrols, esoph$alcgp, sum) * 100

plot(unique(esoph$alcgp), total_prop_alc, xlab="Alcohol group", ylab="Proportion")
```

```{r}
total_prop_tob = tapply(esoph$ncases, esoph$tobgp, sum) / tapply(esoph$ncontrols, esoph$tobgp, sum) * 100

plot(unique(esoph$tobgp), total_prop_tob, xlab="Tobacco group", ylab="Proportion")
```


## Testing hypothesis

### Smoking and cancers correlation
Is there a correlation between smoking habits and oesophageal cancers ?
Hypothesis: H0 = tobacco and cases are independent. Ha = tobacco and cases are correlated.
Let's use the xtabs function to generate a table showing the number of people with and without cancer corresponding to the smoking categories.
```{r}
tobacco <- xtabs(cbind(ncases, ncontrols) ~ tobgp, data=esoph)
tobacco
summary(tobacco)
```
The capital gain is 0.0003702. This is below the threshold, by default 0.05, so we can reject the H0 hypothesis that smoking and the number of cancers are independent. This therefore shows a relationship between smoking habits and œsophageal cancer.

### Age and cancers correlation
Do we get cancer more easily with age (according to alcohol and tobacco consumption) ?
We add a column prop_cases, which represents the positive diagnosed cases for each group combination, normalised by number of controls.
```{r}
age <- esoph$agegp
alcohol <- esoph$alcgp
tobacco <- esoph$tobgp
prop_cases <- esoph$ncases / esoph$ncontrols * 100
esoph_prop <- data.frame(age, alcohol, tobacco, prop_cases)

summary(esoph_prop$prop_cases)
```
We see that this is in fact a percentage, from 0% to 100%, with a mean of 34.68% positive cases.

First, it can be seen here that alcohol consumption has less of an effect than tobacco on low-dose cancer cases. However, at higher doses, the effects of alcohol catch up with those of tobacco.
With alcohol consumption above 80 g/day, tobacco consumption has almost no effect on cancer cases.
```{r}
library(ggplot2)
ggplot(esoph_prop, aes(alcohol, prop_cases, fill=tobacco)) + geom_bar(stat="identity", position="dodge")
```
Let's try to build a model.


# Building a model

### Linear Regression

```{r}
# Proportion of cases by age
qplot(age, prop_cases, data=esoph_prop)

# Proportion of cases by age according to alcohol and tobacco consumption
qplot(age, prop_cases, colour=alcohol, data=esoph_prop)
qplot(age, prop_cases, colour=tobacco, data=esoph_prop)

# Proportion of cases by alcohol and tobacco consumption according to age
qplot(age, alcohol, colour=prop_cases, data=esoph_prop)
qplot(age, tobacco, colour=prop_cases, data=esoph_prop)
```
We clearly see that the proportion of positive cases is higher when the person is old. However, we see that the 75+ group doesn't have so much cases, which can maybe be explained by the fact that people with cancer die before...

(Model in progress...)

### (Attempt of logistic regression)
```{r}
# see http://analyticsdataexploration.com/deviance-and-aic-for-logistic-regression-in-r/
model1 <- glm(cbind(ncases, ncontrols) ~ agegp + tobgp + alcgp, data=esoph, family=binomial())
model2 <- glm(cbind(ncases, ncontrols) ~ agegp + tobgp * alcgp, data=esoph, family=binomial())
summary(model1)
summary(model2)
```
AIC is a maximum likelihood estimate which penalizes to prevent overfitting. It measures flexibility of the models. It is analogous to adjusted R2 in multiple linear regression where it tries to prevent you from including irrelevant predictor variables. Lower AIC of model is better than the model having higher AIC.


## Other

75+ less high consumption
```{r}
table(esoph$agegp, esoph$alcgp)
```

Average number of cases per age and alcohol:
```{r}
tapply(esoph$ncases, list(esoph$agegp, esoph$alcgp), mean)
```